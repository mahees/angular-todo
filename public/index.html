<html ng-app="app">

<head>
    <title>Hello Controllers in AngularJS</title>
</head>

<body>
    <ng-view></ng-view>
    <!-- Libraries -->
    <script type="application/javascript" src="bower_components/angular/angular.min.js"></script>
    <script type="application/javascript" src="bower_components/angular-route/angular-route.min.js"></script>
    <script type="application/javascript" src="bower_components/angular-local-storage/dist/angular-local-storage.min.js"></script>
    <!-- Template -->
    <script type="text/ng-template" id="/todos.html">
        <h1>My awesome todo list</h1>
        <h4>Remaining count {{remainingCount()}}</h4>
        <input type="text" ng-model="searchText" placeholder="filter" />
        <br/>
        <ul>
            <li ng-repeat="todo in todos | filter:searchText"">
                <todo model="todo" id="{{$index}}"></todo>
            </li>
        </ul>
        <a href="#/new">Add Todo</a>
        <button ng-click="alertJoke()">Alert A Joke</button>
    </script>
    <script type="text/ng-template" id="/todoDetails.html">
        <h1>{{ todo.name }}</h1>
        <p>
            <input type="checkbox" ng-model="todo.completed"> completed
        </p>
        <p>
            Name:
            <br />
            <input type="input" ng-model="todo.name" />
        </p>
        <p>
            note
            <br />
            <textarea ng-model="todo.note">{{ todo.note }}</textarea>
        </p>
        <p>
            <button ng-click="saveTodo(todo)">{{!newTodo ? "Update" : "Save"}}</button>
        </p>
    </script>
    <script>
    angular.module('app', ['ngRoute', 'LocalStorageModule'])

    .factory('TodoService', function(localStorageService) {

        var svc = {};

        svc.getAllTodos = function() {
            var todos = localStorageService.get('todos');
            if (todos) {
                return todos;
            }
            svc.seedTodos();
            return svc.getAllTodos();
        };

        svc.getTodo = function(id) {
            var todos = localStorageService.get('todos');
            for (var i = todos.length - 1; i >= 0; i--) {
                if (todos[i].id == id) {
                    return todos[i];
                }
            };
            return null;
        };

        svc.saveTodo = function(todo) {
            var todos = localStorageService.get('todos') || [];
            todo.id = todos.length;
            todos.push(todo);
            localStorageService.set('todos', todos);
        };

        svc.seedTodos = function() {
            var todoSeed = [{
                name: 'AngularJS Directives',
                completed: true,
                note: 'add notes...'
            }, {
                name: 'Data binding',
                completed: true,
                note: 'add notes...'
            }, {
                name: '$scope',
                completed: true,
                note: 'add notes...'
            }, {
                name: 'Controllers and Modules',
                completed: true,
                note: 'add notes...'
            }, {
                name: 'Templates and routes',
                completed: true,
                note: 'add notes...'
            }, {
                name: 'Filters and Services',
                completed: false,
                note: 'add notes...'
            }, {
                name: 'Get started with Node/ExpressJS',
                completed: false,
                note: 'add notes...'
            }, {
                name: 'Setup MongoDB database',
                completed: false,
                note: 'add notes...'
            }, {
                name: 'Be awesome!',
                completed: false,
                note: 'add notes...'
            }];

            for (var i = todoSeed.length - 1; i >= 0; i--) {
                svc.saveTodo(todoSeed[i]);
            };
        };

        return svc;
    })

    .directive('todo', function() {
        return {
            restrict: 'EA', //E = element, A = attribute, C = class, M = comment         
            scope: {
                //@ reads the attribute value, = provides two-way binding, & works with functions
                model: '=',
                id: '@'
            },
            template: '<input type="checkbox" ng-model="model.completed"><a href="#/{{id}}">{{model.name}}</a>',
            link: function($scope, element, attrs) {
                element.bind('mouseenter', function() {
                    element.css('background-color', 'yellow');
                });
                element.bind('mouseleave', function() {
                    element.css('background-color', 'white');
                });
            }
        }
    })

    .controller('TodoController', ['$scope', 'TodoService', '$http', function($scope, TodoService, $http) {
        $scope.todos = TodoService.getAllTodos();

        $scope.remainingCount = function() {
            var counter = 0;
            for (var i = $scope.todos.length - 1; i >= 0; i--) {
                if (!$scope.todos[i].completed) {
                    counter++;
                }
            };
            return counter;
        };

        $scope.alertJoke = function() {
            $http({
                method: 'GET',
                url: 'http://api.icndb.com/jokes/random'
            }).then(function successCallback(response) {
                // this callback will be called asynchronously
                // when the response is available
                console.log(response)
                alert(response.data.value.joke)
            }, function errorCallback(response) {
                // called asynchronously if an error occurs
                // or server returns response with an error status.
            });
        };

    }])

    .controller('TodoDetailCtrl', ['$scope', '$routeParams', 'TodoService', function($scope, $routeParams, TodoService) {
        $scope.todo = TodoService.getTodo($routeParams.id);
    }])

    .controller('NewTodoCtrl', ['$scope', '$routeParams', 'TodoService', '$location', function($scope, $routeParams, TodoService, $location) {
        $scope.todo = {};

        $scope.newTodo = true;

        $scope.saveTodo = function() {
            TodoService.saveTodo($scope.todo);
            $location.path('/');
        }

    }])

    .config(['$routeProvider', function($routeProvider) {
        $routeProvider
            .when('/', {
                templateUrl: '/todos.html',
                controller: 'TodoController'
            })

        .when('/new', {
            templateUrl: '/todoDetails.html',
            controller: 'NewTodoCtrl'
        })

        .when('/:id', {
            templateUrl: '/todoDetails.html',
            controller: 'TodoDetailCtrl'
        });
    }]);
    </script>
</body>

</html>